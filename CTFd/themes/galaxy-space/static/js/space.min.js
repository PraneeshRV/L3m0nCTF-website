document.addEventListener('DOMContentLoaded', function () {
    console.log("Optimized Space.js starting...");
    const canvas = document.createElement('canvas');
    canvas.id = 'space-canvas';
    const ctx = canvas.getContext('2d');
    document.body.appendChild(canvas);

    canvas.style.position = 'fixed';
    canvas.style.top = '0';
    canvas.style.left = '0';
    canvas.style.width = '100vw';
    canvas.style.height = '100vh';
    canvas.style.zIndex = '-1';
    canvas.style.pointerEvents = 'none';

    let width, height;
    let stars = [];
    const numStars = 350; // Reduced from 1200 for performance

    // Simplified star colors
    const starColors = ['#ffffff', '#fff4ea', '#cad7ff', '#ffd2a1'];

    function resize() {
        width = window.innerWidth;
        height = window.innerHeight;
        canvas.width = width;
        canvas.height = height;
        initStars();
        console.log("Resized to", width, height);
    }

    function initStars() {
        stars = [];
        for (let i = 0; i < numStars; i++) {
            stars.push({
                x: Math.random() * width,
                y: Math.random() * height,
                size: Math.random() * 1.5 + 0.5,
                color: starColors[Math.floor(Math.random() * starColors.length)],
                twinkleOffset: Math.random() * Math.PI * 2,
                twinkleSpeed: 0.001 + Math.random() * 0.002,
                vx: (Math.random() - 0.5) * 0.1,
                vy: (Math.random() - 0.5) * 0.1
            });
        }
    }

    let mouseX = 0;
    let mouseY = 0;
    let shootingStars = [];

    document.addEventListener('mousemove', (e) => {
        mouseX = (e.clientX - width / 2) * 0.02;
        mouseY = (e.clientY - height / 2) * 0.02;
    });

    // Optimized shooting star creation
    function createShootingStar() {
        const startX = Math.random() * width;
        const startY = Math.random() * height * 0.3;
        const angle = Math.PI / 4 + (Math.random() - 0.5) * Math.PI / 6;
        const speed = 2 + Math.random() * 3;

        shootingStars.push({
            x: startX,
            y: startY,
            vx: Math.cos(angle) * speed,
            vy: Math.sin(angle) * speed,
            trail: [],
            maxTrail: 50, // Reduced from 30 for performance
            life: 2,
            decay: 0.002
        });
    }

    // Less frequent shooting stars for performance
    setInterval(() => {
        if (Math.random() < 0.75) { // 75% chance
            createShootingStar();
        }
    }, 3000); // Every 3 seconds

    function animate() {
        // Clear canvas completely for crisp, visible stars
        ctx.clearRect(0, 0, width, height);

        // Draw stars efficiently
        stars.forEach(star => {
            // Subtle drift
            star.x += star.vx + (mouseX * 0.005);
            star.y += star.vy + (mouseY * 0.005);

            // Wrap around
            if (star.x < 0) star.x = width;
            if (star.x > width) star.x = 0;
            if (star.y < 0) star.y = height;
            if (star.y > height) star.y = 0;

            // Twinkling effect
            const twinkle = Math.sin(Date.now() * star.twinkleSpeed + star.twinkleOffset) * 0.3 + 0.7;

            // Draw star without expensive shadows
            ctx.beginPath();
            ctx.arc(star.x, star.y, star.size, 0, Math.PI * 2);
            ctx.fillStyle = star.color.replace('#', '#').concat(Math.floor(twinkle * 255).toString(16).padStart(2, '0'));
            ctx.fill();
        });

        // Draw shooting stars (optimized)
        shootingStars.forEach((ss, index) => {
            ss.x += ss.vx;
            ss.y += ss.vy;
            ss.life -= ss.decay;

            ss.trail.push({ x: ss.x, y: ss.y, life: ss.life });
            if (ss.trail.length > ss.maxTrail) ss.trail.shift();

            // Draw trail without expensive shadows
            ss.trail.forEach((point, i) => {
                const trailAlpha = (i / ss.trail.length) * point.life;
                const size = (i / ss.trail.length) * 2;

                ctx.beginPath();
                ctx.arc(point.x, point.y, size, 0, Math.PI * 2);
                ctx.fillStyle = `rgba(255, 255, 255, ${trailAlpha * 0.8})`;
                ctx.fill();
            });

            // Draw head
            ctx.beginPath();
            ctx.arc(ss.x, ss.y, 2, 0, Math.PI * 2);
            ctx.fillStyle = `rgba(255, 255, 255, ${ss.life})`;
            ctx.fill();

            // Remove dead shooting stars
            if (ss.life <= 0 || ss.x < 0 || ss.x > width || ss.y > height) {
                shootingStars.splice(index, 1);
            }
        });

        requestAnimationFrame(animate);
    }

    window.addEventListener('resize', resize);
    resize();
    animate();

    // Create initial shooting star
    setTimeout(createShootingStar, 2000);

    console.log("Animation started with", numStars, "stars (optimized for 60fps)");
});
